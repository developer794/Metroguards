// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
// output   = "../app/generated/prisma"


generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  provider = "postgresql"
  url = env("POSTGRES_URL")  
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  posts     Post[]
  approvedBookings Booking[] @relation("ApprovedBookings")
  approvedQuotations Quotation[] @relation("ApprovedQuotations")
}

model Post {
  id         Int       @id @default(autoincrement())
  title      String
  slug       String    @unique
  excerpt    String?
  content    String     // will store HTML from TipTap
  coverImage String?    // image URL from Cloudinary
  tags       String[]   @default([])
  published  Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  authorId   Int
  author     User      @relation(fields: [authorId], references: [id])
}

model ContactInquiry {
  id          Int      @id @default(autoincrement())
  name        String
  email       String
  phone       String?
  serviceType String
  location    String
  message     String   @db.Text
  status      String   @default("new")  // new, contacted, resolved
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Quotation {
  id              Int       @id @default(autoincrement())
  name            String
  email           String
  phone           String?
  industry        String
  service         String
  location        String?
  message         String?   @db.Text
  status          String    @default("new")  // new, contacted, resolved, approved
  
  // Enhanced quotation fields
  companyName     String?
  guardsRequired  Int?      @default(1)
  hoursPerWeek    Decimal?  @db.Decimal(5, 2)
  startDate       DateTime? @db.Date
  endDate         DateTime? @db.Date
  estimatedCost   Decimal?  @db.Decimal(12, 2)
  gstAmount       Decimal?  @db.Decimal(10, 2)
  grandTotal      Decimal?  @db.Decimal(12, 2)
  costBreakdown   String?   @db.Text  // JSON stored as text
  
  // Approval workflow
  isApproved      Boolean   @default(false)
  approvedAt      DateTime?
  approvedBy      Int?
  approvedByUser  User?     @relation("ApprovedQuotations", fields: [approvedBy], references: [id])
  bookingId       Int?
  booking         Booking?  @relation(fields: [bookingId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Reverse relations
  bookings        Booking[] @relation("QuotationBookings")
}

model ServiceRate {
  id                  Int       @id @default(autoincrement())
  name                String    @unique
  description         String?   @db.Text
  hourlyRate          Decimal   @db.Decimal(10, 2)
  overtimeMultiplier1 Decimal   @default(1.5) @db.Decimal(4, 2)  // First 2 hours
  overtimeMultiplier2 Decimal   @default(2.0) @db.Decimal(4, 2)  // After 2 hours
  isActive            Boolean   @default(true)
  effectiveFrom       DateTime  @default(now())
  effectiveTo         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @default(now()) @updatedAt
}

model Site {
  id                  Int       @id @default(autoincrement())
  name                String
  address             String    @db.Text
  suburb              String?
  postcode            String?
  state               String?   @default("VIC")
  contactName         String?
  contactPhone        String?
  contactEmail        String?
  industry            String?
  specialInstructions String?   @db.Text
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @default(now()) @updatedAt
  
  bookings            Booking[]
}

model Booking {
  id                  Int       @id @default(autoincrement())
  quotationId         Int?
  quotation           Quotation? @relation("QuotationBookings", fields: [quotationId], references: [id])
  siteId              Int?
  site                Site?     @relation(fields: [siteId], references: [id])
  
  clientName          String
  clientEmail         String
  clientPhone         String?
  companyName         String?
  industry            String?
  serviceType         String
  
  startDate           DateTime
  endDate             DateTime?
  numberOfGuards      Int       @default(1)
  hoursPerDay         Decimal   @default(8.0) @db.Decimal(4, 2)
  
  estimatedTotalHours Decimal?  @db.Decimal(10, 2)
  estimatedTotalCost  Decimal?  @db.Decimal(12, 2)
  gstAmount           Decimal?  @db.Decimal(10, 2)
  grandTotal          Decimal?  @db.Decimal(12, 2)
  
  status              String    @default("confirmed")  // confirmed, in_progress, completed, cancelled
  notes               String?   @db.Text
  
  approvedBy          Int?
  approvedByUser      User?     @relation("ApprovedBookings", fields: [approvedBy], references: [id])
  approvedAt          DateTime?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @default(now()) @updatedAt
  
  schedules           Schedule[]
  linkedQuotations    Quotation[]
}

model Schedule {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  guardName       String?
  shiftDate       DateTime  @db.Date
  startTime       DateTime  @db.Time()
  endTime         DateTime  @db.Time()
  breakMinutes    Int       @default(0)
  
  rateType        String    // References ServiceRate.name
  hourlyRate      Decimal   @db.Decimal(10, 2)
  regularHours    Decimal   @default(0) @db.Decimal(4, 2)
  overtimeHours1  Decimal   @default(0) @db.Decimal(4, 2)  // First 2 hours at 1.5x
  overtimeHours2  Decimal   @default(0) @db.Decimal(4, 2)  // Beyond 2 hours at 2x
  totalCost       Decimal   @db.Decimal(10, 2)
  
  isPublicHoliday Boolean   @default(false)
  holidayName     String?
  
  status          String    @default("scheduled")  // scheduled, completed, cancelled
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt

  @@index([bookingId])
  @@index([shiftDate])
}

model PublicHoliday {
  id            Int       @id @default(autoincrement())
  name          String
  date          DateTime  @db.Date
  state         String    @default("VIC")
  year          Int
  isNewYearsEve Boolean   @default(false)
  createdAt     DateTime  @default(now())

  @@unique([date, state])
  @@index([date])
}